<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory OS - Completesolution</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME CONFIGURATION --- */
        :root {
            /* BRAND COLORS (LOCKED) */
            --brand-blue: #0056b3;
            --brand-red: #dc3545;
            
            /* UI COLORS */
            --bg-body: #f8fafc;
            --surface-white: rgba(255, 255, 255, 0.85);
            --surface-glass: rgba(255, 255, 255, 0.6);
            --border-light: rgba(255, 255, 255, 0.5);
            --border-subtle: rgba(0, 0, 0, 0.04);
            
            --text-main: #0f172a;
            --text-muted: #64748b;
            --text-light: #94a3b8;

            --primary-glow: rgba(0, 86, 179, 0.15);
            --danger-glow: rgba(220, 53, 69, 0.15);
        }

        * { box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0;
            color: var(--text-main);
            background-color: var(--bg-body);
            min-height: 100vh;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            position: relative;
        }

        /* --- BACKGROUND MESH ANIMATION (The "Aurora" Effect) --- */
        .aurora-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            background: 
                radial-gradient(at 0% 0%, rgba(200, 220, 255, 0.4) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(255, 230, 230, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(230, 240, 255, 0.4) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(245, 245, 245, 1) 0px, transparent 50%);
            filter: blur(40px);
            animation: breathe 10s ease-in-out infinite alternate;
        }
        .grid-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 30px 30px; opacity: 0.3;
        }

        @keyframes breathe {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        /* --- INTRO SEQUENCE --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .intro-brand { text-align: center; }
        .intro-logo i { 
            font-size: 70px; color: var(--brand-blue); 
            margin-bottom: 20px;
            filter: drop-shadow(0 10px 20px var(--primary-glow));
            animation: floatIcon 3s ease-in-out infinite;
        }
        .intro-title {
            font-family: 'Outfit', sans-serif; font-size: 38px; font-weight: 800;
            color: var(--brand-blue); letter-spacing: -1px;
            opacity: 0; animation: fadeUp 0.8s ease forwards 0.2s;
        }
        .intro-sub {
            font-size: 14px; color: var(--text-muted); letter-spacing: 2px; text-transform: uppercase; margin-top: 10px;
            opacity: 0; animation: fadeUp 0.8s ease forwards 0.4s;
        }

        @keyframes floatIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MAIN APP CONTAINER (Bento Style) --- */
        .app-shell {
            width: 95%; max-width: 1350px; height: 90vh;
            background: var(--surface-white);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border: 1px solid var(--border-light);
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
            display: flex; flex-direction: column;
            overflow: hidden;
            opacity: 0; transform: scale(0.98);
            transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .app-loaded { opacity: 1; transform: scale(1); }

        /* --- UPLOADER ZONE --- */
        #uploaderView {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .drop-zone {
            width: 100%; max-width: 500px; padding: 60px 40px;
            border: 2px dashed rgba(0, 86, 179, 0.2); border-radius: 24px;
            background: linear-gradient(180deg, rgba(255,255,255,0.5) 0%, rgba(240,245,255,0.3) 100%);
            transition: all 0.3s ease; cursor: pointer;
        }
        .drop-zone:hover {
            border-color: var(--brand-blue); transform: translateY(-5px);
            box-shadow: 0 20px 40px var(--primary-glow);
        }
        .upload-icon-circle {
            width: 80px; height: 80px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: var(--brand-blue);
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin: 0 auto 20px;
        }
        .upload-h1 { font-family: 'Outfit', sans-serif; font-size: 24px; font-weight: 700; color: var(--text-main); margin-bottom: 10px; }
        .upload-p { color: var(--text-muted); font-size: 14px; margin-bottom: 30px; line-height: 1.5; }
        .btn-browse {
            background: var(--brand-main); color: white; padding: 12px 30px; border-radius: 50px;
            background: var(--brand-blue); font-weight: 600; font-size: 14px;
            display: inline-flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 86, 179, 0.3);
        }

        /* --- DASHBOARD VIEW --- */
        #dashboardView { display: flex; flex-direction: column; height: 100%; }

        /* Header */
        .top-bar {
            padding: 20px 30px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-subtle);
        }
        .brand-lockup { display: flex; align-items: center; gap: 12px; }
        .brand-text { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 18px; color: var(--brand-blue); }
        .meta-pill {
            background: white; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 100px;
            font-size: 12px; font-weight: 600; color: var(--text-muted);
            display: flex; align-items: center; gap: 8px;
        }

        /* Content Grid */
        .main-content {
            flex: 1; padding: 25px 30px; overflow: hidden;
            display: flex; flex-direction: column; gap: 20px;
        }

        /* Stats Row */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stat-card {
            background: white; border-radius: 20px; padding: 25px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 20px rgba(0,0,0,0.02);
            display: flex; align-items: center; justify-content: space-between;
            position: relative; overflow: hidden;
        }
        /* Aesthetic Glows */
        .stat-card.blue::before { content:''; position:absolute; top:0; right:0; width:100px; height:100px; background:var(--primary-glow); filter:blur(40px); border-radius:50%; }
        .stat-card.red::before { content:''; position:absolute; top:0; right:0; width:100px; height:100px; background:var(--danger-glow); filter:blur(40px); border-radius:50%; }

        .stat-label { font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        .stat-value { font-family: 'Outfit', sans-serif; font-size: 36px; font-weight: 700; color: var(--text-main); margin-top: 5px; }
        .stat-icon { font-size: 28px; opacity: 0.8; }

        /* Toolbar */
        .toolbar-area { display: flex; justify-content: space-between; align-items: center; }
        .search-container { position: relative; width: 350px; }
        .search-input {
            width: 100%; padding: 12px 20px 12px 45px;
            border-radius: 12px; border: 1px solid #e2e8f0; background: white;
            font-family: 'Inter', sans-serif; font-size: 14px;
            transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--brand-blue); box-shadow: 0 0 0 3px var(--primary-glow); }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #cbd5e1; }
        
        .action-btn {
            border: none; padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-ghost:hover { background: #f1f5f9; color: var(--brand-red); }
        .btn-primary { background: var(--text-main); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary:hover { transform: translateY(-2px); background: black; }

        /* Modern Table */
        .table-wrapper {
            flex: 1; background: white; border-radius: 20px; border: 1px solid var(--border-subtle);
            overflow: hidden; display: flex; flex-direction: column;
        }
        .table-scroll { overflow-y: auto; flex: 1; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; }
        
        thead th {
            position: sticky; top: 0; background: #f8fafc; z-index: 10;
            text-align: left; padding: 16px 24px;
            font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tbody tr { border-bottom: 1px solid #f1f5f9; transition: background 0.1s; animation: slideIn 0.3s ease forwards; opacity: 0; }
        tbody tr:hover { background: #f8fafc; }
        td { padding: 14px 24px; font-size: 13px; color: var(--text-main); }
        
        /* Staggered Animation for Rows */
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Modern Status Indicators */
        .status-dot {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500;
        }
        .status-dot::before { content: ''; width: 6px; height: 6px; border-radius: 50%; }
        
        .status-ok { color: #15803d; background: #f0fdf4; }
        .status-ok::before { background: #15803d; }
        
        .status-warning { color: #b91c1c; background: #fef2f2; }
        .status-warning::before { background: #b91c1c; }

        /* Code Pill */
        .code-tag { 
            font-family: 'Inter', monospace; font-size: 12px; background: #f1f5f9; color: #475569;
            padding: 2px 6px; border-radius: 4px; border: 1px solid #e2e8f0;
        }

        .del-icon { color: #cbd5e1; cursor: pointer; transition: 0.2s; }
        .del-icon:hover { color: var(--brand-red); }

        /* --- UPDATED NATIONAL SUMMARY SECTION --- */
        .national-area { 
            background: #f8fafc; 
            padding: 20px 25px; 
            border-top: 1px solid #e2e8f0;
            display: flex; flex-direction: column; 
            height: 200px; /* Fixed height for consistency */
        }
        .nat-title { font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; letter-spacing: 0.5px; }
        
        /* Scrolling Card Container */
        .nat-list { 
            overflow-x: auto; 
            display: flex; 
            gap: 16px; 
            padding-bottom: 10px; /* Space for scrollbar */
            flex-wrap: nowrap;
        }
        /* Custom Scrollbar */
        .nat-list::-webkit-scrollbar { height: 6px; }
        .nat-list::-webkit-scrollbar-track { background: transparent; }
        .nat-list::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

        /* New Card Design */
        .nat-card { 
            background: white; 
            border: 1px solid #e2e8f0; 
            padding: 16px; 
            border-radius: 12px;
            min-width: 180px; 
            max-width: 220px;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, border-color 0.2s;
        }
        .nat-card:hover {
            transform: translateY(-3px);
            border-color: var(--brand-blue);
        }

        /* Card Internals */
        .nc-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .nc-code { font-weight: 700; color: var(--brand-blue); font-size: 13px; }
        .nc-uom { font-size: 10px; text-transform: uppercase; color: #94a3b8; font-weight: 600; letter-spacing: 0.5px; }
        
        .nc-qty { 
            font-family: 'Outfit', sans-serif; 
            font-size: 24px; 
            font-weight: 800; 
            color: var(--text-main); 
            line-height: 1.2;
        }
        
        .nc-name { 
            font-size: 11px; 
            color: #64748b; 
            margin-top: 8px; 
            text-transform: uppercase; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
        }

        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div class="aurora-bg"></div>
    <div class="grid-overlay"></div>

    <div id="intro-overlay">
        <div class="intro-brand">
            <div class="intro-logo"><i class="fas fa-prescription"></i></div>
            <div class="intro-title">Completesolution <span style="color:#dc3545">Pharmacy</span></div>
            <div class="intro-sub">Next-Gen Inventory System</div>
        </div>
    </div>

    <div class="app-shell" id="appShell">
        
        <div id="uploaderView">
            <div class="drop-zone">
                <div class="upload-icon-circle"><i class="fas fa-cloud-upload-alt"></i></div>
                <h1 class="upload-h1">Import Data</h1>
                <p class="upload-p">Drag and drop your Excel inventory file here.<br>The system handles expiration & damage detection automatically.</p>
                <label for="excelInput" class="btn-browse">
                    <i class="fas fa-folder-open"></i> Browse Files
                </label>
                <input type="file" id="excelInput" accept=".xlsx, .xls" style="display:none;">
            </div>
            <div style="margin-top: 20px; font-size: 11px; color: #94a3b8; font-weight: 600;">DESIGNED BY GELO</div>
        </div>

        <div id="dashboardView" class="hidden">
            
            <div class="top-bar">
                <div class="brand-lockup">
                    <i class="fas fa-prescription" style="color:var(--brand-blue); font-size: 20px;"></i>
                    <div class="brand-text">Completesolution <span style="color:var(--brand-red)">Pharmacy</span></div>
                </div>
                <div class="meta-pill">
                    <i class="far fa-calendar"></i> <span id="currentDate">...</span>
                </div>
            </div>

            <div class="main-content">
                
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div>
                            <div class="stat-label">Total Good Stock</div>
                            <div class="stat-value" id="totalGoodStock">0</div>
                        </div>
                        <i class="fas fa-check-circle stat-icon" style="color:var(--brand-blue)"></i>
                    </div>
                    <div class="stat-card red">
                        <div>
                            <div class="stat-label">Total Bad Stock</div>
                            <div class="stat-value" id="totalBadStock" style="color:var(--brand-red)">0</div>
                        </div>
                        <i class="fas fa-exclamation-triangle stat-icon" style="color:var(--brand-red)"></i>
                    </div>
                </div>

                <div class="toolbar-area">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchInput" class="search-input" placeholder="Search branch, code, or item..." onkeyup="filterData()">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="location.reload()" class="action-btn btn-ghost">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                        <button onclick="exportReportToExcel()" class="action-btn btn-primary">
                            <i class="fas fa-file-excel"></i> Export Report
                        </button>
                    </div>
                </div>

                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th style="width:40px;"></th>
                                    <th>Branch</th>
                                    <th>Code</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit</th>
                                    <th>Lot No</th>
                                    <th>Expiry</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                </tbody>
                        </table>
                    </div>
                    
                    <div class="national-area">
                        <div class="nat-title">National Aggregation (Summary)</div>
                        <div class="nat-list" id="nationalList">
                            </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        let allData = []; 
        let badStockTotal = 0; 
        const today = new Date();

        // --- ANIMATION CONTROLLER ---
        window.addEventListener('load', () => {
            setTimeout(() => {
                const intro = document.getElementById('intro-overlay');
                intro.style.opacity = '0';
                document.getElementById('appShell').classList.add('app-loaded');
                setTimeout(() => { intro.style.display = 'none'; }, 800);
            }, 2200);
        });

        // --- DATE SETTING ---
        const dateOptions = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        document.getElementById('currentDate').innerText = today.toLocaleDateString('en-US', dateOptions).toUpperCase();

        // --- FILE HANDLING ---
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                processInitialData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        });

        function findValue(row, possibleKeys) {
            for (let key of possibleKeys) { if (row[key] !== undefined) return row[key]; }
            return ''; 
        }

        function processInitialData(rawData) {
            const excludedKeywords = ['EXPIRED', 'DAMAGE', 'DAMA', 'QUARANTINE', 'BAD ORDER', 'BO', 'REJECT', 'RET'];
            allData = [];
            badStockTotal = 0;

            rawData.forEach(row => {
                let branch = findValue(row, ['Location Code', 'Location', 'Branch']);
                let rawQty = findValue(row, ['On Hand Qty', 'Onhand Qty', 'Quantity', 'Qty']);
                let qty = parseFloat(String(rawQty).replace(/,/g, '')) || 0;

                let isBadStock = false;
                if (branch) {
                    const upperBranch = String(branch).toUpperCase();
                    if (excludedKeywords.some(keyword => upperBranch.includes(keyword))) { isBadStock = true; }
                }

                if (isBadStock) {
                    badStockTotal += qty;
                } else {
                    allData.push({
                        branch: branch,
                        code: findValue(row, ['Stock Code', 'Code', 'Item Code']),
                        name: findValue(row, ['Stock Name', 'Name', 'Item Description']),
                        qty: qty,
                        uom: findValue(row, ['UOM', 'Unit']),
                        lot: findValue(row, ['Stock Batch No', 'Lot No']),
                        rawExpiry: findValue(row, ['Expiry', 'Expiry Date'])
                    });
                }
            });

            // Sort by Branch then Code
            allData.sort((a, b) => {
                const branchA = (a.branch || '').toString().toUpperCase();
                const branchB = (b.branch || '').toString().toUpperCase();
                if (branchA !== branchB) return branchA < branchB ? -1 : 1;
                return (a.code || '').toString().localeCompare((b.code || '').toString());
            });

            // Transition UI
            document.getElementById('uploaderView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            
            renderUI(allData);
        }

        function filterData() {
            const query = document.getElementById('searchInput').value.toUpperCase();
            const filteredData = allData.filter(item => {
                return (item.branch && item.branch.toString().toUpperCase().includes(query)) ||
                       (item.code && item.code.toString().toUpperCase().includes(query)) ||
                       (item.name && item.name.toString().toUpperCase().includes(query));
            });
            renderUI(filteredData);
        }

        window.deleteRow = function(index) {
            const itemToDelete = window.currentRenderedData[index];
            if(confirm('Remove this line item?')) {
                allData = allData.filter(i => i !== itemToDelete);
                filterData();
            }
        };

        function renderUI(dataToRender) {
            window.currentRenderedData = dataToRender; 
            let goodStockTotal = 0;
            let nationalSummary = {};
            let tableHTML = '';

            dataToRender.forEach((item, index) => {
                goodStockTotal += item.qty;

                // National Aggregation Logic
                if (item.code) {
                    if (!nationalSummary[item.code]) { 
                        nationalSummary[item.code] = { name: item.name, uom: item.uom, totalQty: 0 }; 
                    }
                    nationalSummary[item.code].totalQty += item.qty;
                }

                // Expiry Logic
                let expiryDisplay = '';
                let statusClass = 'status-ok';
                let statusText = 'Good';
                
                if (item.rawExpiry) {
                    let expDate = new Date(item.rawExpiry);
                    if (!isNaN(expDate)) {
                        expiryDisplay = expDate.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'2-digit'});
                        let oneYearFromNow = new Date();
                        oneYearFromNow.setFullYear(today.getFullYear() + 1);
                        if (expDate < oneYearFromNow) { 
                            statusClass = 'status-warning';
                            statusText = 'Near Expiry';
                        }
                    } else { expiryDisplay = item.rawExpiry; }
                }

                // Staggered Animation Delay
                let delay = Math.min(index * 0.05, 1) + 's';

                tableHTML += `
                    <tr style="animation-delay: ${delay}">
                        <td style="text-align:center;"><i class="fas fa-times del-icon" onclick="deleteRow(${index})"></i></td>
                        <td style="font-weight:600; color:var(--brand-blue);">${item.branch}</td>
                        <td><span class="code-tag">${item.code}</span></td>
                        <td>${item.name}</td>
                        <td style="font-weight:700;">${item.qty}</td>
                        <td style="color:#94a3b8; font-size:12px;">${item.uom}</td>
                        <td style="font-family:'Inter', monospace; color:#64748b;">${item.lot}</td>
                        <td>${expiryDisplay}</td>
                        <td><div class="status-dot ${statusClass}">${statusText}</div></td>
                    </tr>`;
            });

            // Update DOM
            document.getElementById('tableBody').innerHTML = tableHTML;
            document.getElementById('totalGoodStock').innerText = goodStockTotal.toLocaleString();
            document.getElementById('totalBadStock').innerText = badStockTotal.toLocaleString();

            // Render National Summary (NEW CARD DESIGN)
            let natList = Object.keys(nationalSummary).map(key => ({ code: key, ...nationalSummary[key] }));
            natList.sort((a, b) => (a.code || '').toString().localeCompare((b.code || '').toString()));

            let natHTML = '';
            natList.forEach(item => {
                // Ensure text safety
                let safeName = item.name ? item.name : '';
                let safeUom = item.uom ? item.uom : '';

                natHTML += `
                <div class="nat-card">
                    <div class="nc-top">
                        <span class="nc-code">${item.code}</span>
                        <span class="nc-uom">${safeUom}</span>
                    </div>
                    <div class="nc-qty">${item.totalQty.toLocaleString()}</div>
                    <div class="nc-name" title="${safeName}">${safeName}</div>
                </div>`;
            });
            document.getElementById('nationalList').innerHTML = natHTML;
        }

        // --- EXPORT (PRESERVED LOGIC) ---
        function exportReportToExcel() {
            let data = window.currentRenderedData;
            
            // STRICT EXCEL TEMPLATE - DO NOT CHANGE STYLE
            let tableHTML = `
                <table border="1" style="font-family: Tahoma; font-size: 8pt; width: 100%;">
                    <thead>
                        <tr style="height:30px;">
                            <th style="background-color:#FFFF00; font-weight:700;">BRANCH</th>
                            <th style="background-color:#FFFF00; font-weight:700;">CODE</th>
                            <th style="background-color:#FFFF00; font-weight:700;">NAME</th>
                            <th style="background-color:#FFFF00; font-weight:700;">ENDING</th>
                            <th style="background-color:#FFFF00; font-weight:700;">UOM</th>
                            <th style="background-color:#FFFF00; font-weight:700;">LOT NO</th>
                            <th style="background-color:#FFFF00; font-weight:700;">EXPIRY</th>
                            <th style="background-color:#FFFF00; font-weight:700;">REMARKS</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            let grandTotal = 0;
            let natSummary = {};

            data.forEach(item => {
                grandTotal += item.qty;
                if (item.code) {
                    if (!natSummary[item.code]) { natSummary[item.code] = { name: item.name, uom: item.uom, totalQty: 0 }; }
                    natSummary[item.code].totalQty += item.qty;
                }

                let expiryDisplay = '';
                let remarks = '';
                let style = '';

                if (item.rawExpiry) {
                    let expDate = new Date(item.rawExpiry);
                    if (!isNaN(expDate)) {
                        expiryDisplay = expDate.toLocaleDateString('en-US');
                        let oneYearFromNow = new Date();
                        oneYearFromNow.setFullYear(today.getFullYear() + 1);
                        if (expDate < oneYearFromNow) { 
                            style = 'color:#FF0000;'; 
                            remarks = 'NEAR EXPIRY';
                        }
                    } else { expiryDisplay = item.rawExpiry; }
                }

                tableHTML += `
                    <tr style="${style} height:20px;">
                        <td style="vertical-align:middle; padding:5px;">${item.branch}</td>
                        <td style="vertical-align:middle; text-align:center; mso-number-format:'\@';">${item.code}</td>
                        <td style="vertical-align:middle;">${item.name}</td>
                        <td style="vertical-align:middle; text-align:center;">${item.qty}</td>
                        <td style="vertical-align:middle; text-align:center;">${item.uom}</td>
                        <td style="vertical-align:middle; text-align:center; mso-number-format:'\@';">${item.lot}</td>
                        <td style="vertical-align:middle; text-align:center;">${expiryDisplay}</td>
                        <td style="vertical-align:middle; text-align:center;">${remarks}</td>
                    </tr>`;
            });

            tableHTML += `<tr style="background-color:#e0e0e0; font-weight:bold; height:25px;"><td colspan="3" style="text-align:right;">GRAND TOTAL:</td><td style="text-align:center;">${grandTotal}</td><td colspan="4"></td></tr></tbody></table>`;

            let natList = Object.keys(natSummary).map(key => ({ code: key, ...natSummary[key] }));
            natList.sort((a, b) => (a.code || '').toString().localeCompare((b.code || '').toString()));
            let natTotal = 0;

            let natHTML = `
                <br><br>
                <div style="font-weight:bold; font-family:Tahoma; font-size:10pt; color:#000;">NATIONAL SUMMARY (GOOD STOCK ONLY)</div>
                <table border="1" style="font-family: Tahoma; font-size: 8pt; width: 100%;">
                    <thead>
                        <tr style="height:30px;">
                            <th style="background-color:#FFFF00; font-weight:700;">CODE</th>
                            <th style="background-color:#FFFF00; font-weight:700;">NAME</th>
                            <th style="background-color:#FFFF00; font-weight:700;">ENDING</th>
                            <th style="background-color:#FFFF00; font-weight:700;">UOM</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            natList.forEach(item => {
                natTotal += item.totalQty;
                natHTML += `<tr style="height:20px;"><td style="text-align:center; mso-number-format:'\@';">${item.code}</td><td>${item.name}</td><td style="text-align:center; font-weight:bold;">${item.totalQty}</td><td style="text-align:center;">${item.uom}</td></tr>`;
            });
            natHTML += `<tr style="background-color:#e0e0e0; font-weight:bold; height:25px;"><td colspan="2" style="text-align:right;">TOTAL:</td><td style="text-align:center;">${natTotal}</td><td></td></tr></tbody></table>`;

            var template = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                </head>
                <body>
                    <div style="text-align:center; margin-bottom:40px;">
                        <span style="font-family:Arial; font-size:24pt; font-weight:bold; color:#0056b3;">Completesolution</span>
                        <span style="font-family:Arial; font-size:24pt; font-weight:bold; color:#dc3545;">Pharmacy</span>
                        <br><br>
                        <div style="font-family:Arial; font-size:12pt; font-weight:bold; color:#000;">
                            INVENTORY REPORT &#8226; MULTICARE &#8226; AS OF ${today.toLocaleDateString('en-US').toUpperCase()}
                        </div>
                    </div>
                    <br><br> ${tableHTML} ${natHTML}
                </body>
                </html>`;

            var blob = new Blob([template], { type: 'application/vnd.ms-excel;charset=utf-8' });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Inventory_Report_${today.toISOString().slice(0,10)}.xls`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
