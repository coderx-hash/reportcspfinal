<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory OS - Completesolution</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME CONFIGURATION --- */
        :root {
            /* BRAND COLORS (LOCKED) */
            --brand-blue: #0056b3;
            --brand-red: #dc3545;
            
            /* UI COLORS */
            --bg-body: #f8fafc;
            --surface-white: rgba(255, 255, 255, 0.75);
            --surface-solid: #ffffff;
            --border-light: rgba(255, 255, 255, 0.6);
            --border-subtle: rgba(0, 0, 0, 0.05);
            
            --text-main: #0f172a;
            --text-muted: #64748b;
            --text-light: #94a3b8;

            --primary-glow: rgba(0, 86, 179, 0.25);
            --danger-glow: rgba(220, 53, 69, 0.25);
            --shadow-soft: 0 20px 40px -10px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; outline: none; -webkit-font-smoothing: antialiased; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; padding: 0;
            color: var(--text-main);
            background-color: var(--bg-body);
            height: 100vh;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
            position: relative;
        }

        /* --- BACKGROUND MOVEMENT (AURORA) --- */
        .aurora-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            overflow: hidden;
            background: #f8fafc;
        }

        .aurora-blob {
            position: absolute;
            filter: blur(80px);
            opacity: 0.6;
            animation: drift 20s infinite alternate ease-in-out;
            border-radius: 50%;
        }

        .blob-1 {
            top: -10%; left: -10%; width: 50vw; height: 50vw;
            background: rgba(200, 220, 255, 0.5); /* Light Blue */
            animation-duration: 25s;
        }
        
        .blob-2 {
            bottom: -10%; right: -10%; width: 60vw; height: 60vw;
            background: rgba(230, 240, 255, 0.6); /* Lighter Blue */
            animation-duration: 22s;
            animation-direction: alternate-reverse;
        }

        .blob-3 {
            top: 40%; left: 40%; width: 40vw; height: 40vw;
            background: rgba(255, 230, 230, 0.4); /* Light Red tint */
            animation: float 18s infinite ease-in-out;
        }

        .grid-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 30px 30px; opacity: 0.3;
        }

        @keyframes drift {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(30px, 50px) scale(1.1); }
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(50px, -50px) rotate(10deg); }
            66% { transform: translate(-20px, 20px) rotate(-5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* --- INTRO SEQUENCE --- */
        #intro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: transform 1s cubic-bezier(0.77, 0, 0.175, 1); 
        }

        .intro-content { text-align: center; position: relative; z-index: 2; }
        
        .intro-logo-box {
            width: 100px; height: 100px;
            background: white;
            border-radius: 28px;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 25px;
            box-shadow: 0 20px 40px var(--primary-glow);
            animation: popIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .intro-logo i { 
            font-size: 50px; color: var(--brand-blue); 
            animation: heartbeat 2s infinite ease-in-out;
        }
        
        .intro-title {
            font-family: 'Outfit', sans-serif; font-size: 42px; font-weight: 800;
            color: var(--brand-blue); 
            letter-spacing: -1.5px;
            margin-bottom: 5px;
            overflow: hidden;
            opacity: 0; animation: fadeUp 0.8s ease forwards 0.3s;
        }
        
        .intro-sub {
            font-size: 13px; color: var(--text-muted); letter-spacing: 3px; 
            text-transform: uppercase; font-weight: 600;
            opacity: 0; animation: fadeUp 0.8s ease forwards 0.5s;
        }

        /* --- ASTIG NA DESIGNED BY GELO ANIMATION --- */
        .intro-credits {
            margin-top: 40px;
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 12px;
            color: var(--text-light);
            display: flex;
            justify-content: center;
            gap: 3px;
            text-transform: uppercase;
        }

        .falling-char {
            display: inline-block;
            opacity: 0;
            /* Ang animation ay nagpapabigat ng dating */
            animation: letterDrop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            /* Staggered delay based on variable --i */
            animation-delay: calc(1s + (var(--i) * 0.05s));
        }

        /* Space between DESIGNED and BY and GELO */
        .spacer { width: 8px; }

        @keyframes letterDrop {
            0% { 
                transform: translateY(-200px) scale(3); 
                opacity: 0; 
                filter: blur(10px);
            }
            70% {
                transform: translateY(10px) scale(0.9); /* Overshoot/Squash effect */
                opacity: 1;
                filter: blur(0);
            }
            100% { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
                filter: blur(0);
            }
        }

        .loader-bar {
            width: 200px; height: 4px; background: #f1f5f9; border-radius: 4px;
            margin: 30px auto 0; overflow: hidden;
            opacity: 0; animation: fadeUp 0.5s ease forwards 1.8s; /* Delayed appearance */
        }
        
        .loader-fill {
            height: 100%; width: 0%; background: var(--brand-blue); border-radius: 4px;
            animation: loading 2.2s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }

        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); filter: drop-shadow(0 0 10px var(--primary-glow)); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes loading { 0% { width: 0%; } 100% { width: 100%; } }

        .intro-exit { transform: translateY(-100%); }

        /* --- MAIN APP CONTAINER --- */
        .app-shell {
            width: 95%; max-width: 1400px; height: 92vh;
            background: var(--surface-white);
            backdrop-filter: blur(40px) saturate(150%); -webkit-backdrop-filter: blur(40px) saturate(150%);
            border: 1px solid var(--border-light);
            border-radius: 36px;
            box-shadow: 0 40px 80px -20px rgba(0, 0, 0, 0.15);
            display: flex; flex-direction: column;
            overflow: hidden;
            opacity: 0; transform: scale(0.92) translateY(30px);
            transition: all 1s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .app-loaded { opacity: 1; transform: scale(1) translateY(0); }

        /* --- UPLOADER ZONE --- */
        #uploaderView {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
            position: relative;
        }
        .drop-zone {
            width: 100%; max-width: 550px; padding: 70px 50px;
            border: 2px dashed #cbd5e1; border-radius: 32px;
            background: linear-gradient(145deg, rgba(255,255,255,0.6) 0%, rgba(240,245,255,0.4) 100%);
            transition: all 0.3s ease; cursor: pointer;
            position: relative; overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .drop-zone:hover, .drop-zone:active {
            border-color: var(--brand-blue); transform: translateY(-5px);
            box-shadow: 0 25px 50px -10px var(--primary-glow);
        }
        .drop-zone:hover .upload-icon-circle {
            transform: scale(1.1) rotate(5deg);
            background: var(--brand-blue); color: white;
        }
        
        .upload-icon-circle {
            width: 90px; height: 90px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 36px; color: var(--brand-blue);
            box-shadow: 0 15px 30px rgba(0,0,0,0.08); margin: 0 auto 25px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .upload-h1 { font-family: 'Outfit', sans-serif; font-size: 28px; font-weight: 800; color: var(--text-main); margin: 0 0 12px 0; }
        .upload-p { color: var(--text-muted); font-size: 15px; margin-bottom: 35px; line-height: 1.6; max-width: 80%; margin-left: auto; margin-right: auto; }
        
        .btn-browse {
            background: var(--text-main); color: white; padding: 16px 36px; border-radius: 16px;
            font-weight: 600; font-size: 14px; letter-spacing: 0.5px;
            display: inline-flex; align-items: center; gap: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: 0.2s;
            cursor: pointer;
            position: relative;
            z-index: 10;
            pointer-events: none;
        }
        .drop-zone:hover .btn-browse { background: var(--brand-blue); box-shadow: 0 10px 25px var(--primary-glow); }

        .file-input-hidden {
            position: absolute; width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; z-index: -1;
        }

        /* --- DASHBOARD VIEW --- */
        #dashboardView { display: flex; flex-direction: column; height: 100%; }

        /* Header */
        .top-bar {
            padding: 24px 32px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-subtle);
            background: rgba(255,255,255,0.4);
        }
        .brand-lockup { display: flex; align-items: center; gap: 14px; }
        .brand-text { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 20px; color: var(--brand-blue); letter-spacing: -0.5px; }
        .meta-pill {
            background: white; border: 1px solid #e2e8f0; padding: 8px 18px; border-radius: 100px;
            font-size: 12px; font-weight: 700; color: var(--text-muted);
            display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        /* Content Grid */
        .main-content {
            flex: 1; padding: 25px 32px; overflow: hidden;
            display: flex; flex-direction: column; gap: 24px;
        }

        /* Stats Row */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .stat-card {
            background: var(--surface-solid); border-radius: 24px; padding: 28px;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: var(--shadow-soft);
            display: flex; align-items: center; justify-content: space-between;
            position: relative; overflow: hidden;
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-card::before { 
            content:''; position:absolute; top:-50px; right:-50px; width:150px; height:150px; 
            filter:blur(50px); border-radius:50%; opacity: 0.5;
            transition: 0.5s;
        }
        .stat-card.blue::before { background: var(--brand-blue); }
        .stat-card.red::before { background: var(--brand-red); }
        .stat-card:hover::before { opacity: 0.8; transform: scale(1.1); }

        .stat-label { font-size: 12px; font-weight: 700; text-transform: uppercase; color: var(--text-light); letter-spacing: 1px; margin-bottom: 8px; }
        .stat-value { font-family: 'Outfit', sans-serif; font-size: 42px; font-weight: 800; color: var(--text-main); line-height: 1; }
        .stat-icon { font-size: 32px; opacity: 0.15; z-index: 1; }

        /* Toolbar */
        .toolbar-area { display: flex; justify-content: space-between; align-items: center; }
        .search-container { position: relative; width: 380px; }
        .search-input {
            width: 100%; padding: 14px 20px 14px 50px;
            border-radius: 16px; border: 1px solid rgba(255,255,255,0.5); 
            background: white;
            font-family: 'Inter', sans-serif; font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--brand-blue); box-shadow: 0 0 0 4px var(--primary-glow); }
        .search-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 14px; }
        
        .action-btn {
            border: none; padding: 12px 24px; border-radius: 14px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-ghost:hover { background: white; color: var(--brand-red); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn-primary { background: var(--text-main); color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .btn-primary:hover { transform: translateY(-2px); background: #000; box-shadow: 0 12px 25px rgba(0,0,0,0.2); }

        /* Modern Table */
        .table-wrapper {
            flex: 1; background: white; border-radius: 24px; 
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: var(--shadow-soft);
            overflow: hidden; display: flex; flex-direction: column;
        }
        .table-scroll { overflow-y: auto; flex: 1; padding-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; }
        
        thead th {
            position: sticky; top: 0; background: #f8fafc; z-index: 10;
            text-align: left; padding: 18px 24px;
            font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tbody tr { border-bottom: 1px solid #f1f5f9; transition: background 0.15s; animation: slideIn 0.4s ease forwards; opacity: 0; }
        tbody tr:hover { background: #f0fdfa; }
        td { padding: 16px 24px; font-size: 13px; color: var(--text-main); }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Status & Pills */
        .status-dot {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 6px 12px; border-radius: 30px; font-size: 11px; font-weight: 700;
        }
        .status-dot::before { content: ''; width: 6px; height: 6px; border-radius: 50%; }
        
        .status-ok { color: #15803d; background: #dcfce7; }
        .status-ok::before { background: #15803d; }
        
        .status-warning { color: #b91c1c; background: #fee2e2; }
        .status-warning::before { background: #b91c1c; }

        .code-tag { 
            font-family: 'Inter', monospace; font-size: 12px; font-weight: 600;
            background: #f1f5f9; color: #475569;
            padding: 4px 8px; border-radius: 6px; border: 1px solid #e2e8f0;
        }

        .del-icon { 
            color: #cbd5e1; cursor: pointer; transition: 0.2s; 
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%;
        }
        .del-icon:hover { color: var(--brand-red); background: #fee2e2; }

        /* --- NATIONAL SUMMARY SECTION --- */
        .national-area { 
            background: #f8fafc; 
            padding: 24px; 
            border-top: 1px solid #e2e8f0;
            display: flex; flex-direction: column; 
            height: 220px; 
        }
        .nat-title { 
            font-size: 11px; font-weight: 800; text-transform: uppercase; color: var(--text-muted); 
            margin-bottom: 16px; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px;
        }
        .nat-title::after { content:''; height: 1px; flex: 1; background: #e2e8f0; }
        
        .nat-list { 
            overflow-x: auto; 
            display: flex; 
            gap: 16px; 
            padding: 5px;
            flex-wrap: nowrap;
        }
        .nat-list::-webkit-scrollbar { height: 6px; }
        .nat-list::-webkit-scrollbar-track { background: transparent; }
        .nat-list::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

        .nat-card { 
            background: white; 
            border: 1px solid #e2e8f0; 
            padding: 18px; 
            border-radius: 16px;
            min-width: 200px; 
            max-width: 240px;
            display: flex; 
            flex-direction: column; 
            justify-content: space-between;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
            position: relative;
        }
        .nat-card:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--brand-blue);
            box-shadow: 0 15px 30px rgba(0, 86, 179, 0.1);
        }

        .nc-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .nc-code { font-weight: 800; color: var(--brand-blue); font-size: 13px; }
        .nc-uom { font-size: 10px; text-transform: uppercase; color: #94a3b8; font-weight: 700; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
        .nc-qty { font-family: 'Outfit', sans-serif; font-size: 28px; font-weight: 800; color: var(--text-main); line-height: 1.1; }
        .nc-name { font-size: 11px; font-weight: 500; color: #64748b; margin-top: 10px; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .hidden { display: none !important; }

        /* Responsive Fixes */
        @media (max-width: 768px) {
            .app-shell { width: 100%; height: 100vh; border-radius: 0; border: none; }
            .stats-grid { grid-template-columns: 1fr; }
            .toolbar-area { flex-direction: column; gap: 10px; align-items: stretch; }
            .search-container { width: 100%; }
            .top-bar { padding: 15px; }
            .intro-title { font-size: 32px; }
        }

    </style>
</head>
<body>

    <div class="aurora-container">
        <div class="aurora-blob blob-1"></div>
        <div class="aurora-blob blob-2"></div>
        <div class="aurora-blob blob-3"></div>
    </div>
    <div class="grid-overlay"></div>

    <div id="intro-overlay">
        <div class="intro-content">
            <div class="intro-logo-box">
                <div class="intro-logo"><i class="fas fa-prescription"></i></div>
            </div>
            <div class="intro-title">Completesolution <span style="color:var(--brand-red)">Pharmacy</span></div>
            <div class="intro-sub">Next-Gen Inventory System</div>
            
            <div class="intro-credits">
                <span class="falling-char" style="--i:1">D</span>
                <span class="falling-char" style="--i:2">E</span>
                <span class="falling-char" style="--i:3">S</span>
                <span class="falling-char" style="--i:4">I</span>
                <span class="falling-char" style="--i:5">G</span>
                <span class="falling-char" style="--i:6">N</span>
                <span class="falling-char" style="--i:7">E</span>
                <span class="falling-char" style="--i:8">D</span>
                
                <span class="spacer"></span>
                
                <span class="falling-char" style="--i:9">B</span>
                <span class="falling-char" style="--i:10">Y</span>

                <span class="spacer"></span>

                <span class="falling-char" style="--i:11; color:var(--brand-blue)">G</span>
                <span class="falling-char" style="--i:12; color:var(--brand-blue)">E</span>
                <span class="falling-char" style="--i:13; color:var(--brand-blue)">L</span>
                <span class="falling-char" style="--i:14; color:var(--brand-blue)">O</span>
            </div>

            <div class="loader-bar"><div class="loader-fill"></div></div>
        </div>
    </div>

    <div class="app-shell" id="appShell">
        
        <div id="uploaderView">
            <div class="drop-zone" onclick="document.getElementById('excelInput').click()">
                <div class="upload-icon-circle"><i class="fas fa-cloud-upload-alt"></i></div>
                <h1 class="upload-h1">Import Inventory</h1>
                <p class="upload-p">Drag and drop your Excel file here.<br>We'll auto-detect expiration & bad stocks.</p>
                
                <div class="btn-browse">
                    <i class="fas fa-folder-open"></i> Select Excel File
                </div>
                <input type="file" id="excelInput" accept=".xlsx, .xls" class="file-input-hidden">
                
            </div>
            </div>

        <div id="dashboardView" class="hidden">
            
            <div class="top-bar">
                <div class="brand-lockup">
                    <i class="fas fa-prescription" style="color:var(--brand-blue); font-size: 24px;"></i>
                    <div class="brand-text">Completesolution <span style="color:var(--brand-red)">Pharmacy</span></div>
                </div>
                <div class="meta-pill">
                    <i class="far fa-calendar-alt" style="color:var(--brand-blue)"></i> <span id="currentDate">...</span>
                </div>
            </div>

            <div class="main-content">
                
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div>
                            <div class="stat-label">Total Good Stock</div>
                            <div class="stat-value" id="totalGoodStock">0</div>
                        </div>
                        <i class="fas fa-check-circle stat-icon" style="color:var(--brand-blue)"></i>
                    </div>
                    <div class="stat-card red">
                        <div>
                            <div class="stat-label">Total Bad Stock</div>
                            <div class="stat-value" id="totalBadStock" style="color:var(--brand-red)">0</div>
                        </div>
                        <i class="fas fa-exclamation-triangle stat-icon" style="color:var(--brand-red)"></i>
                    </div>
                </div>

                <div class="toolbar-area">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchInput" class="search-input" placeholder="Filter by branch, code, or item name..." onkeyup="filterData()">
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 10px;">
                        <button onclick="location.reload()" class="action-btn btn-ghost">
                            <i class="fas fa-redo-alt"></i> Reset
                        </button>
                        <button onclick="exportReportToExcel()" class="action-btn btn-primary">
                            <i class="fas fa-file-export"></i> Export Report
                        </button>
                    </div>
                </div>

                <div class="table-wrapper">
                    <div class="table-scroll">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    <th style="width:50px;"></th>
                                    <th>Branch</th>
                                    <th>Code</th>
                                    <th>Description</th>
                                    <th>Qty</th>
                                    <th>Unit</th>
                                    <th>Lot No</th>
                                    <th>Expiry</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                </tbody>
                        </table>
                    </div>
                    
                    <div class="national-area">
                        <div class="nat-title"><i class="fas fa-chart-pie"></i> National Aggregation (Summary)</div>
                        <div class="nat-list" id="nationalList">
                            </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        let allData = []; 
        let badStockTotal = 0; 
        const today = new Date();

        // --- ANIMATION CONTROLLER ---
        window.addEventListener('load', () => {
            // Intro takes about 3s total to let the falling text animation finish
            setTimeout(() => {
                const intro = document.getElementById('intro-overlay');
                intro.classList.add('intro-exit'); 
                
                setTimeout(() => {
                    document.getElementById('appShell').classList.add('app-loaded');
                }, 300);

                setTimeout(() => { intro.style.display = 'none'; }, 1000);
            }, 3000); // Increased time slightly to enjoy the falling text
        });

        // --- DATE SETTING ---
        const dateOptions = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        document.getElementById('currentDate').innerText = today.toLocaleDateString('en-US', dateOptions).toUpperCase();

        // --- FILE HANDLING ---
        document.getElementById('excelInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return; 
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                processInitialData(jsonData);
            };
            reader.readAsArrayBuffer(file);
            
            this.value = null; // Reset for re-upload
        });

        // --- FIXED: Case Insensitive Finder ---
        function findValue(row, possibleKeys) {
            const rowKeys = Object.keys(row);
            for (let key of possibleKeys) {
                const match = rowKeys.find(k => k.trim().toUpperCase() === key.toUpperCase());
                if (match) return row[match];
            }
            return ''; 
        }

        function processInitialData(rawData) {
            const excludedKeywords = ['EXPIRED', 'DAMAGE', 'DAMA', 'QUARANTINE', 'BAD ORDER', 'BO', 'REJECT', 'RET'];
            allData = [];
            badStockTotal = 0;

            rawData.forEach(row => {
                let branch = findValue(row, ['Location Code', 'Location', 'Branch']);
                let rawQty = findValue(row, ['On Hand Qty', 'Onhand Qty', 'Quantity', 'Qty']);
                let qty = parseFloat(String(rawQty).replace(/,/g, '')) || 0;

                let isBadStock = false;
                if (branch) {
                    const upperBranch = String(branch).toUpperCase();
                    if (excludedKeywords.some(keyword => upperBranch.includes(keyword))) { isBadStock = true; }
                }

                if (isBadStock) {
                    badStockTotal += qty;
                } else {
                    allData.push({
                        branch: branch,
                        code: findValue(row, ['Stock Code', 'Code', 'Item Code']),
                        name: findValue(row, ['Stock Name', 'Name', 'Item Description']),
                        qty: qty,
                        uom: findValue(row, ['UOM', 'Unit']),
                        lot: findValue(row, ['Stock Batch No', 'Lot No', 'Lot', 'Batch', 'Batch No', 'Batch Number', 'Lot Number', 'Lot #']),
                        rawExpiry: findValue(row, ['Expiry', 'Expiry Date'])
                    });
                }
            });

            allData.sort((a, b) => {
                const branchA = (a.branch || '').toString().toUpperCase();
                const branchB = (b.branch || '').toString().toUpperCase();
                if (branchA !== branchB) return branchA < branchB ? -1 : 1;
                return (a.code || '').toString().localeCompare((b.code || '').toString());
            });

            document.getElementById('uploaderView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            
            renderUI(allData);
        }

        function filterData() {
            const query = document.getElementById('searchInput').value.toUpperCase();
            const filteredData = allData.filter(item => {
                return (item.branch && item.branch.toString().toUpperCase().includes(query)) ||
                       (item.code && item.code.toString().toUpperCase().includes(query)) ||
                       (item.name && item.name.toString().toUpperCase().includes(query));
            });
            renderUI(filteredData);
        }

        window.deleteRow = function(index) {
            const itemToDelete = window.currentRenderedData[index];
            if(confirm('Remove this line item?')) {
                allData = allData.filter(i => i !== itemToDelete);
                filterData();
            }
        };

        function renderUI(dataToRender) {
            window.currentRenderedData = dataToRender; 
            let goodStockTotal = 0;
            let nationalSummary = {};
            let tableHTML = '';

            dataToRender.forEach((item, index) => {
                goodStockTotal += item.qty;

                if (item.code) {
                    if (!nationalSummary[item.code]) { 
                        nationalSummary[item.code] = { name: item.name, uom: item.uom, totalQty: 0 }; 
                    }
                    nationalSummary[item.code].totalQty += item.qty;
                }

                let expiryDisplay = '';
                let statusClass = 'status-ok';
                let statusText = 'Good';
                
                if (item.rawExpiry) {
                    let expDate = new Date(item.rawExpiry);
                    if (!isNaN(expDate)) {
                        expiryDisplay = expDate.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'2-digit'});
                        let oneYearFromNow = new Date();
                        oneYearFromNow.setFullYear(today.getFullYear() + 1);
                        if (expDate < oneYearFromNow) { 
                            statusClass = 'status-warning';
                            statusText = 'Near Expiry';
                        }
                    } else { expiryDisplay = item.rawExpiry; }
                }

                let delay = Math.min(index * 0.03, 1) + 's';

                tableHTML += `
                    <tr style="animation-delay: ${delay}">
                        <td style="text-align:center;"><i class="fas fa-times del-icon" onclick="deleteRow(${index})"></i></td>
                        <td style="font-weight:600; color:var(--brand-blue);">${item.branch}</td>
                        <td><span class="code-tag">${item.code}</span></td>
                        <td>${item.name}</td>
                        <td style="font-weight:700;">${item.qty}</td>
                        <td style="color:#94a3b8; font-size:12px;">${item.uom}</td>
                        <td style="font-family:'Inter', monospace; color:#64748b;">${item.lot}</td>
                        <td>${expiryDisplay}</td>
                        <td><div class="status-dot ${statusClass}">${statusText}</div></td>
                    </tr>`;
            });

            document.getElementById('tableBody').innerHTML = tableHTML;
            document.getElementById('totalGoodStock').innerText = goodStockTotal.toLocaleString();
            document.getElementById('totalBadStock').innerText = badStockTotal.toLocaleString();

            let natList = Object.keys(nationalSummary).map(key => ({ code: key, ...nationalSummary[key] }));
            natList.sort((a, b) => (a.code || '').toString().localeCompare((b.code || '').toString()));

            let natHTML = '';
            natList.forEach(item => {
                let safeName = item.name ? item.name : '';
                let safeUom = item.uom ? item.uom : '';

                natHTML += `
                <div class="nat-card">
                    <div class="nc-top">
                        <span class="nc-code">${item.code}</span>
                        <span class="nc-uom">${safeUom}</span>
                    </div>
                    <div class="nc-qty">${item.totalQty.toLocaleString()}</div>
                    <div class="nc-name" title="${safeName}">${safeName}</div>
                </div>`;
            });
            document.getElementById('nationalList').innerHTML = natHTML;
        }

        function exportReportToExcel() {
            let data = window.currentRenderedData;
            
            let tableHTML = `
                <table border="1" style="font-family: Tahoma; font-size: 8pt; width: 100%;">
                    <thead>
                        <tr style="height:30px;">
                            <th style="background-color:#FFFF00; font-weight:700;">BRANCH</th>
                            <th style="background-color:#FFFF00; font-weight:700;">CODE</th>
                            <th style="background-color:#FFFF00; font-weight:700;">NAME</th>
                            <th style="background-color:#FFFF00; font-weight:700;">ENDING</th>
                            <th style="background-color:#FFFF00; font-weight:700;">UOM</th>
                            <th style="background-color:#FFFF00; font-weight:700;">LOT NO</th>
                            <th style="background-color:#FFFF00; font-weight:700;">EXPIRY</th>
                            <th style="background-color:#FFFF00; font-weight:700;">REMARKS</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            let grandTotal = 0;
            let natSummary = {};

            data.forEach(item => {
                grandTotal += item.qty;
                if (item.code) {
                    if (!natSummary[item.code]) { natSummary[item.code] = { name: item.name, uom: item.uom, totalQty: 0 }; }
                    natSummary[item.code].totalQty += item.qty;
                }

                let expiryDisplay = '';
                let remarks = '';
                let style = '';

                if (item.rawExpiry) {
                    let expDate = new Date(item.rawExpiry);
                    if (!isNaN(expDate)) {
                        expiryDisplay = expDate.toLocaleDateString('en-US');
                        let oneYearFromNow = new Date();
                        oneYearFromNow.setFullYear(today.getFullYear() + 1);
                        if (expDate < oneYearFromNow) { 
                            style = 'color:#FF0000;'; 
                            remarks = 'NEAR EXPIRY';
                        }
                    } else { expiryDisplay = item.rawExpiry; }
                }

                tableHTML += `
                    <tr style="${style} height:20px;">
                        <td style="vertical-align:middle; padding:5px;">${item.branch}</td>
                        <td style="vertical-align:middle; text-align:center; mso-number-format:'\@';">${item.code}</td>
                        <td style="vertical-align:middle;">${item.name}</td>
                        <td style="vertical-align:middle; text-align:center;">${item.qty}</td>
                        <td style="vertical-align:middle; text-align:center;">${item.uom}</td>
                        <td style="vertical-align:middle; text-align:center; mso-number-format:'\@';">${item.lot}</td>
                        <td style="vertical-align:middle; text-align:center;">${expiryDisplay}</td>
                        <td style="vertical-align:middle; text-align:center;">${remarks}</td>
                    </tr>`;
            });

            tableHTML += `<tr style="background-color:#e0e0e0; font-weight:bold; height:25px;"><td colspan="3" style="text-align:right;">GRAND TOTAL:</td><td style="text-align:center;">${grandTotal}</td><td colspan="4"></td></tr></tbody></table>`;

            let natList = Object.keys(natSummary).map(key => ({ code: key, ...natSummary[key] }));
            natList.sort((a, b) => (a.code || '').toString().localeCompare((b.code || '').toString()));
            let natTotal = 0;

            let natHTML = `
                <br><br>
                <div style="font-weight:bold; font-family:Tahoma; font-size:10pt; color:#000;">NATIONAL SUMMARY (GOOD STOCK ONLY)</div>
                <table border="1" style="font-family: Tahoma; font-size: 8pt; width: 100%;">
                    <thead>
                        <tr style="height:30px;">
                            <th style="background-color:#FFFF00; font-weight:700;">CODE</th>
                            <th style="background-color:#FFFF00; font-weight:700;">NAME</th>
                            <th style="background-color:#FFFF00; font-weight:700;">ENDING</th>
                            <th style="background-color:#FFFF00; font-weight:700;">UOM</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            natList.forEach(item => {
                natTotal += item.totalQty;
                natHTML += `<tr style="height:20px;"><td style="text-align:center; mso-number-format:'\@';">${item.code}</td><td>${item.name}</td><td style="text-align:center; font-weight:bold;">${item.totalQty}</td><td style="text-align:center;">${item.uom}</td></tr>`;
            });
            natHTML += `<tr style="background-color:#e0e0e0; font-weight:bold; height:25px;"><td colspan="2" style="text-align:right;">TOTAL:</td><td style="text-align:center;">${natTotal}</td><td></td></tr></tbody></table>`;

            var template = `
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                </head>
                <body>
                    <div style="text-align:center; margin-bottom:40px;">
                        <span style="font-family:Arial; font-size:24pt; font-weight:bold; color:#0056b3;">Completesolution</span>
                        <span style="font-family:Arial; font-size:24pt; font-weight:bold; color:#dc3545;">Pharmacy</span>
                        <br><br>
                        <div style="font-family:Arial; font-size:12pt; font-weight:bold; color:#000;">
                            INVENTORY REPORT &#8226; MULTICARE &#8226; AS OF ${today.toLocaleDateString('en-US').toUpperCase()}
                        </div>
                    </div>
                    <br><br> ${tableHTML} ${natHTML}
                </body>
                </html>`;

            var blob = new Blob([template], { type: 'application/vnd.ms-excel;charset=utf-8' });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Inventory_Report_${today.toISOString().slice(0,10)}.xls`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
